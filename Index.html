<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeatBot CRM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Tailwind via CDN (fine for prototype; switch to build step later) [web:662] -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      // ------- CONFIG -------

      // Netlify redirect points /api to your Apps Script web app.
      const API_BASE = "/api";

      // Hard-coded users: username + password + email used in the sheet.
      // Add/remove users here as needed.
      const USERS = [
        { username: "matt",   password: "beatbot1", email: "mattblois@gmail.com" },
        { username: "sara",   password: "beatbot2", email: "sara@example.com" },
        { username: "chris",  password: "beatbot3", email: "chris@example.com" },
        { username: "editor", password: "beatbot4", email: "editor@example.com" }
      ];

      let CURRENT_USER = null;

      // ------- GENERIC API HELPER -------

      async function apiCall(action, params = {}) {
        if (!CURRENT_USER) {
          throw new Error("Not logged in");
        }

        const url = new URL(window.location.origin + API_BASE);
        url.searchParams.set("action", action);
        url.searchParams.set("user", CURRENT_USER.email);

        Object.entries(params).forEach(([key, value]) => {
          url.searchParams.set(key, value);
        });

        const res = await fetch(url.toString(), {
          method: "GET"
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`API error: ${res.status} ${text}`);
        }
        return res.json();
      }

      // ------- LOGIN LOGIC -------

      function handleLogin(event) {
        event.preventDefault();

        const usernameInput = document.getElementById("login-username");
        const passwordInput = document.getElementById("login-password");
        const errorEl = document.getElementById("login-error");

        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        const user = USERS.find(
          (u) => u.username === username && u.password === password
        );

        if (!user) {
          errorEl.textContent = "Invalid username or password.";
          errorEl.classList.remove("hidden");
          return;
        }

        CURRENT_USER = user;
        errorEl.classList.add("hidden");
        passwordInput.value = "";

        document.getElementById("current-user-label").textContent =
          user.username + " (" + user.email + ")";

        // Hide auth, show dashboard
        document.getElementById("auth").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");

        loadContacts();
      }

      function handleLogout() {
        CURRENT_USER = null;
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("auth").classList.remove("hidden");
        document.getElementById("contacts-body").innerHTML = "";
        document.getElementById("login-username").value = "";
        document.getElementById("login-password").value = "";
      }

      // ------- CONTACTS UI -------

      async function loadContacts() {
        const tbody = document.getElementById("contacts-body");
        const statusEl = document.getElementById("status");
        tbody.innerHTML = "";
        statusEl.textContent = "Loading contacts...";

        try {
          const data = await apiCall("getContacts");
          // Expecting an array of contact objects or rows; adjust to your real shape.
          // Example: [{name, outlet, beat, email, twitter, notes}, ...]
          if (!Array.isArray(data)) {
            statusEl.textContent = "Unexpected response from server.";
            return;
          }

          data.forEach((row) => {
            const tr = document.createElement("tr");
            tr.className = "border-b border-gray-200";

            const name = row.name || row.Name || "";
            const outlet = row.outlet || row.Outlet || "";
            const beat = row.beat || row.Beat || "";
            const email = row.email || row.Email || "";
            const twitter = row.twitter || row.Twitter || "";
            const notes = row.notes || row.Notes || "";

            tr.innerHTML = `
              <td class="px-3 py-2 text-sm text-gray-900">${name}</td>
              <td class="px-3 py-2 text-sm text-gray-500">${outlet}</td>
              <td class="px-3 py-2 text-sm text-gray-500">${beat}</td>
              <td class="px-3 py-2 text-sm text-blue-600">${email}</td>
              <td class="px-3 py-2 text-sm text-blue-600">${twitter}</td>
              <td class="px-3 py-2 text-sm text-gray-500">${notes}</td>
            `;
            tbody.appendChild(tr);
          });

          statusEl.textContent =
            data.length === 0 ? "No contacts yet for this user." : "";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Failed to load contacts.";
        }
      }

      async function handleAddContact(event) {
        event.preventDefault();
        const form = event.target;
        const statusEl = document.getElementById("status");

        const payload = {
          name: form["name"].value,
          outlet: form["outlet"].value,
          beat: form["beat"].value,
          email: form["email"].value,
          twitter: form["twitter"].value,
          notes: form["notes"].value
        };

        statusEl.textContent = "Saving contact...";

        try {
          await apiCall("addContact", payload);
          statusEl.textContent = "Saved.";
          form.reset();
          loadContacts();
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Failed to save contact.";
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("login-form")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("logout-btn")
          .addEventListener("click", handleLogout);
        document
          .getElementById("add-contact-form")
          .addEventListener("submit", handleAddContact);
      });
    </script>
  </head>

  <body class="min-h-screen bg-slate-900 text-white">
    <!-- AUTH SCREEN -->
    <div
      id="auth"
      class="min-h-screen flex items-center justify-center px-4"
    >
      <div class="w-full max-w-md bg-slate-800 rounded-xl shadow-lg p-8">
        <h1 class="text-2xl font-semibold mb-6 text-center">
          BeatBot Login
        </h1>

        <form id="login-form" class="space-y-4">
          <div>
            <label
              for="login-username"
              class="block text-sm font-medium text-gray-200"
              >Username</label
            >
            <input
              id="login-username"
              type="text"
              required
              class="mt-1 block w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="matt"
            />
          </div>

          <div>
            <label
              for="login-password"
              class="block text-sm font-medium text-gray-200"
              >Password</label
            >
            <input
              id="login-password"
              type="password"
              required
              class="mt-1 block w-full rounded-md border border-slate-600 bg-slate-900 px-3 py-2 text-sm text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="••••••••"
            />
          </div>

          <p
            id="login-error"
            class="hidden text-sm text-red-400"
          ></p>

          <button
            type="submit"
            class="w-full mt-4 inline-flex justify-center rounded-md bg-indigo-500 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          >
            Sign in
          </button>

          <p class="mt-3 text-xs text-gray-400 text-center">
            2–4 accounts are hard‑coded in the app config for now.
          </p>
        </form>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden min-h-screen">
      <header
        class="flex items-center justify-between px-6 py-4 border-b border-slate-700 bg-slate-900/80 backdrop-blur"
      >
        <div>
          <h1 class="text-xl font-semibold">BeatBot CRM</h1>
          <p class="text-xs text-gray-400">
            Signed in as
            <span id="current-user-label" class="font-mono"></span>
          </p>
        </div>
        <button
          id="logout-btn"
          class="rounded-md border border-slate-600 px-3 py-1.5 text-xs font-medium text-gray-200 hover:bg-slate-800"
        >
          Log out
        </button>
      </header>

      <main class="px-4 py-4 lg:px-8 lg:py-6 space-y-6">
        <!-- Status -->
        <div
          id="status"
          class="text-sm text-gray-300"
        ></div>

        <!-- Add contact form -->
        <section
          class="bg-slate-800 border border-slate-700 rounded-xl p-4 lg:p-5"
        >
          <h2 class="text-sm font-semibold mb-3">
            Add contact
          </h2>
          <form
            id="add-contact-form"
            class="grid grid-cols-1 md:grid-cols-3 gap-3"
          >
            <div>
              <label
                class="block text-xs font-medium text-gray-300"
                >Name</label
              >
              <input
                name="name"
                class="mt-1 w-full rounded-md border border-slate-600 bg-slate-900 px-2 py-1.5 text-xs text-gray-100"
                required
              />
            </div>
            <div>
              <label
                class="block text-xs font-medium text-gray-300"
                >Outlet</label
              >
              <input
                name="outlet"
                class="mt-1 w-full rounded-md border border-slate-600 bg-slate-900 px-2 py-1.5 text-xs text-gray-100"
              />
            </div>
            <div>
              <label
                class="block text-xs font-medium text-gray-300"
                >Beat</label
              >
              <input
                name="beat"
                class="mt-1 w-full rounded-md border border-slate-600 bg-slate-900 px-2 py-1.5 text-xs text-gray-100"
              />
            </div>
            <div>
              <label
                class="block text-xs font-medium text-gray-300"
                >Email</label
              >
              <input
                type="email"
                name="email"
                class="mt-1 w-full rounded-md border border-slate-600 bg-slate-900 px-2 py-1.5 text-xs text-gray-100"
              />
            </div>
            <div>
              <label
                class="block text-xs font-medium text-gray-300"
                >Twitter</label
              >
              <input
                name="twitter"
                class="mt-1 w-full rounded-md border border-slate-600 bg-slate-900 px-2 py-1.5 text-xs text-gray-100"
              />
            </div>
            <div>
              <label
                class="block text-xs font-medium text-gray-300"
                >Notes</label
              >
              <input
                name="notes"
                class="mt-1 w-full rounded-md border border-slate-600 bg-slate-900 px-2 py-1.5 text-xs text-gray-100"
              />
            </div>
            <div class="md:col-span-3 flex justify-end items-end">
              <button
                type="submit"
                class="inline-flex items-center rounded-md bg-indigo-500 px-3 py-1.5 text-xs font-medium text-white hover:bg-indigo-600"
              >
                Add contact
              </button>
            </div>
          </form>
        </section>

        <!-- Contacts table -->
        <section
          class="bg-slate-800 border border-slate-700 rounded-xl p-4 lg:p-5"
        >
          <h2 class="text-sm font-semibold mb-3">
            Contacts
          </h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-left text-xs">
              <thead class="bg-slate-900">
                <tr>
                  <th class="px-3 py-2 font-medium text-gray-300">Name</th>
                  <th class="px-3 py-2 font-medium text-gray-300">Outlet</th>
                  <th class="px-3 py-2 font-medium text-gray-300">Beat</th>
                  <th class="px-3 py-2 font-medium text-gray-300">Email</th>
                  <th class="px-3 py-2 font-medium text-gray-300">Twitter</th>
                  <th class="px-3 py-2 font-medium text-gray-300">Notes</th>
                </tr>
              </thead>
              <tbody id="contacts-body" class="divide-y divide-slate-700">
                <!-- Populated by loadContacts() -->
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>
